{% extends "base.html" %}

{% block title %}Monitor - IBN Platform{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Network Monitoring</h1>
    <p class="text-gray-600">Real-time BGP and BFD status</p>
</div>

<div class="mb-4">
    <button onclick="refreshStatus()"
        class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
        Refresh Status
    </button>
    <span class="ml-4 text-sm text-gray-500">Auto-refresh:
        <button onclick="toggleAutoRefresh()" id="auto-refresh-btn" class="text-indigo-600 underline">Enable</button>
    </span>
</div>

<div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">Device Status</h2>
    <div id="status-panel" hx-get="/api/monitor/status" hx-trigger="load" hx-swap="innerHTML">
        <div class="animate-pulse flex space-x-4">
            <div class="flex-1 space-y-4 py-1">
                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">BGP Neighbors</h2>
        <div id="bgp-panel" hx-get="/api/monitor/bgp" hx-trigger="load" hx-swap="innerHTML">
            <div class="animate-pulse">Loading...</div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">BFD Sessions</h2>
        <div id="bfd-panel" hx-get="/api/monitor/bfd" hx-trigger="load" hx-swap="innerHTML">
            <div class="animate-pulse">Loading...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let autoRefreshInterval = null;

function refreshStatus() {
    htmx.trigger('#status-panel', 'htmx:trigger');
    htmx.trigger('#bgp-panel', 'htmx:trigger');
    htmx.trigger('#bfd-panel', 'htmx:trigger');

    document.getElementById('status-panel').innerHTML = '<div class="animate-pulse">Refreshing...</div>';
    fetch('/api/monitor/status').then(r => r.json()).then(data => renderStatus(data));
    fetch('/api/monitor/bgp').then(r => r.json()).then(data => renderBGP(data));
    fetch('/api/monitor/bfd').then(r => r.json()).then(data => renderBFD(data));
}

function toggleAutoRefresh() {
    const btn = document.getElementById('auto-refresh-btn');
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        btn.textContent = 'Enable';
    } else {
        autoRefreshInterval = setInterval(refreshStatus, 30000);
        btn.textContent = 'Disable';
    }
}

function renderStatus(data) {
    const panel = document.getElementById('status-panel');
    if (!data.devices || data.devices.length === 0) {
        panel.innerHTML = '<p class="text-gray-500">No devices found</p>';
        return;
    }
    let html = '<table class="min-w-full"><thead><tr><th class="text-left py-2">Device</th><th class="text-left">IP</th><th class="text-left">Vendor</th><th class="text-left">Status</th></tr></thead><tbody>';
    data.devices.forEach(d => {
        const statusClass = d.status === 'up' ? 'text-green-600' : 'text-gray-500';
        html += `<tr><td class="py-2 font-medium">${d.name}</td><td>${d.mgmt_ip}</td><td>${d.vendor}</td><td class="${statusClass}">${d.status}</td></tr>`;
    });
    html += '</tbody></table>';
    panel.innerHTML = html;
}

function renderBGP(data) {
    const panel = document.getElementById('bgp-panel');
    if (!data.bgp_status || data.bgp_status.length === 0) {
        panel.innerHTML = '<p class="text-gray-500">No BGP data</p>';
        return;
    }
    let html = '<div class="space-y-2">';
    data.bgp_status.forEach(d => {
        html += `<div class="p-2 bg-gray-50 rounded"><strong>${d.device}</strong> - ${d.status}</div>`;
    });
    html += '</div>';
    panel.innerHTML = html;
}

function renderBFD(data) {
    const panel = document.getElementById('bfd-panel');
    if (!data.bfd_status || data.bfd_status.length === 0) {
        panel.innerHTML = '<p class="text-gray-500">No BFD data</p>';
        return;
    }
    let html = '<div class="space-y-2">';
    data.bfd_status.forEach(d => {
        html += `<div class="p-2 bg-gray-50 rounded"><strong>${d.device}</strong> - ${d.status}</div>`;
    });
    html += '</div>';
    panel.innerHTML = html;
}

// Initial load
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/monitor/status').then(r => r.json()).then(data => renderStatus(data));
    fetch('/api/monitor/bgp').then(r => r.json()).then(data => renderBGP(data));
    fetch('/api/monitor/bfd').then(r => r.json()).then(data => renderBFD(data));
});
</script>
{% endblock %}
