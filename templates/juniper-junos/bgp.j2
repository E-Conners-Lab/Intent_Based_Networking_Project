# =============================================================================
# IBN Platform Generated Configuration - Juniper JunOS
# =============================================================================
# Hostname: {{ config.hostname }}
# Intent: {{ intent.name }}
# Service: {{ service.name }}
# Generated by IBN Platform
# =============================================================================
#
# WARNING: This configuration is managed by IBN Platform.
# Manual changes may be overwritten.
#
# =============================================================================

# === HOSTNAME ===
set system host-name {{ config.hostname }}

# === ROUTING OPTIONS ===
set routing-options router-id {{ config.router_id }}
set routing-options autonomous-system {{ config.bgp_as }}

# === BGP CONFIGURATION ===
{% for neighbor in config.neighbors %}
# {{ "PRIMARY" if neighbor.is_primary else "BACKUP" }} path via {{ neighbor.name }}
set protocols bgp group IBN-PEERS type internal
set protocols bgp group IBN-PEERS neighbor {{ neighbor.ip }} description "{{ neighbor.name }}"
set protocols bgp group IBN-PEERS neighbor {{ neighbor.ip }} import {{ neighbor.route_map_in }}
{% if service.bfd.enabled %}
set protocols bgp group IBN-PEERS neighbor {{ neighbor.ip }} bfd-liveness-detection minimum-interval {{ service.bfd.interval_ms }}
set protocols bgp group IBN-PEERS neighbor {{ neighbor.ip }} bfd-liveness-detection multiplier {{ service.bfd.multiplier }}
{% endif %}
{% endfor %}

# === POLICY OPTIONS (Route Policies) ===
{% for rm in config.route_maps %}
set policy-options policy-statement {{ rm.name }} term 10 then local-preference {{ rm.local_preference }}
set policy-options policy-statement {{ rm.name }} term 10 then community add {{ rm.community | replace(':', '-') }}
set policy-options policy-statement {{ rm.name }} term 10 then accept
set policy-options community {{ rm.community | replace(':', '-') }} members {{ rm.community }}
{% endfor %}

# === NETWORK ADVERTISEMENTS ===
{% for network in config.advertise_networks %}
# {{ network }}
{% set parts = network.split() %}
{% if parts | length >= 2 %}
set protocols bgp group IBN-PEERS export ADVERTISE-LOOPBACKS
set policy-options policy-statement ADVERTISE-LOOPBACKS term LOOPBACK from route-filter {{ parts[1] }}/32 exact
set policy-options policy-statement ADVERTISE-LOOPBACKS term LOOPBACK then accept
{% endif %}
{% endfor %}

# === INTERFACE CONFIGURATION ===
{% for iface in config.interfaces %}
set interfaces {{ iface.name | replace('GigabitEthernet', 'ge-0/0/') }} unit 0 description "{{ iface.description }}"
set interfaces {{ iface.name | replace('GigabitEthernet', 'ge-0/0/') }} unit 0 family inet address {{ iface.ip_address }}/30
{% if iface.bfd_enabled %}
set protocols bfd interface {{ iface.name | replace('GigabitEthernet', 'ge-0/0/') }} minimum-interval {{ iface.bfd_interval }}
set protocols bfd interface {{ iface.name | replace('GigabitEthernet', 'ge-0/0/') }} multiplier {{ iface.bfd_multiplier }}
{% endif %}
{% endfor %}

# === END IBN CONFIGURATION ===
